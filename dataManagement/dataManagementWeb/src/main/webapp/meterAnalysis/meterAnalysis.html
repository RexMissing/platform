<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>维修分析记录录入</title>
    <link href="lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css"/>
    <script src="lib/json2.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerDialog.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerTextBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerCheckBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerComboBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerGrid.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerDateEditor.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerSpinner.js" type="text/javascript"></script>
    <script type="text/javascript">
        $.ligerDialog.close("#addMeterAnalysis");
        $(function(){
            $.post($.URL.enumTable.mislist, null, enumMisListCallBack, "json");
            $.post($.URL.enumTable.misinfolist, null, enumMisInfoListCallBack, "json");
            $.post($.URL.enumTable.cuslist, null, enumCusListCallBack, "json");
            $.post($.URL.enumTable.elelist, null, enumEleListCallBack, "json");
            $.post($.URL.department.list,null,departListCallBack,"json");
            $.post($.URL.meterAnalysis.list, null,listCallback,"json");
        });
        function getCookie(cname) {
            var ss = document.cookie;
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for(var i = 0 ;i < ca.length ; i++)
            {
                var c = ca[i].trim();
                if (c.indexOf(name)==0)
                    return c.substring(name.length,c.length);
            }
            return "";
        }

        var enumData=[];
        function enumMisListCallBack(data) {
            if (data.code == 200) {
                $("#freportmisfune").empty();
                $("#freportmisfune").append("<option value='无'>无</option>");
                for(var i = 0; i < data.data.length; i++){
                    $("#freportmisfune").append("<option value='" + data.data[i].fenumname + "'>" + data.data[i].fenumname + "</option>");
                }
                $("#fconfirmmisfune").empty();
                for(var i = 0; i < data.data.length; i++){
                    $("#fconfirmmisfune").append("<option value='" + data.data[i].fenumname + "'>" + data.data[i].fenumname + "</option>");
                }
            }
        }

        function enumMisInfoListCallBack(data) {
            $("#fmisfuneinfo").empty();
            for(var i = 0; i < data.data.length; i++){
                $("#fmisfuneinfo").append("<option value='" + data.data[i].fenumname + "'>" + data.data[i].fenumname + "</option>");
            }
        }

        function enumCusListCallBack(data) {
            $("#fcustomer").empty();
            for(var i = 0; i < data.data.length; i++){
                $("#fcustomer").append("<option value='" + data.data[i].fenumname + "'>" + data.data[i].fenumname + "</option>");
            }
        }
        function enumEleListCallBack(data) {
            $("#felecdisplay").empty();
            for(var i = 0; i < data.data.length; i++){
                $("#felecdisplay").append("<option value='" + data.data[i].fenumname + "'>" + data.data[i].fenumname + "</option>");
            }
        }

        var departData=[];
        function departListCallBack(data) {
            if (data.code == 200) {
                $.each(data.data, function (index, content) {
                    var j = {};
                    j.text = content.departName;
                    j.value = content.departNo;
                    departData.push(j);
                });
                $("#fdepartment").ligerComboBox({
                    isShowCheckBox: true, emptyText: null, /*实现下拉表*/
                    data: departData,
                    width: 200,
                    valueField: 'value',
                    textField: 'text',
                    valueFieldID: 'departSelect'
                });
            }
        }

        var gridData = {};
        function listCallback(data) {
            if (data.code == 200) {
                gridData.Rows = data.data;
                gridData.Total = data.data.length;
                f_initGrid();
            }
        }
        var manager, g;
        function f_initGrid() {
                g = manager = $("#maingrid").ligerGrid({
                    columns: [
                        {display: '主键', name: 'id', width: '5%', type: 'int', frozen:true},
                        {display: '表具编号', name: 'fmetercode', width: '9%',editor: {type: 'text'}},
                        {display: '表具类型', name: 'fmetername', width: '8%', editor: {type: 'text'}},
                        {display: '基表条码', name: 'fvalvename', width: '8%', editor: {type: 'text'}},
                        {
                            display: '部门', name: 'fdepartment', width: '8%', type: 'text',
                            editor: {
                                type: 'select',
                                emptyText: null,
                                data: departData,
                                valueField: 'value',
                                textField: 'text'
                            },
                            render: function (item) {
                                return item.departenum;
                            }
                        },
                        {display: '分析员', name: 'fanalysor', width: '8%', editor: {type: 'text'}},
                        {display: '燃气公司', name: 'fcustomer', width: '8%', editor: {type: 'text'}},
                        {
                            display: '报修故障', name: 'freportmisfune', width: '9%', type: 'int',
                            editor: {
                                type: 'select',
                                emptyText: null,
                                data: enumData,
                                valueField: 'value',
                                textField: 'text'
                            },
                            render: function (item) {
                                return item.reportenum;
                            }
                        },
                        {
                            display: '实查故障', name: 'fconfirmmisfune', width: '9%', type: 'int',
                            editor: {
                                type: 'select',
                                emptyText: null,
                                data: enumData,
                                valueField: 'value',
                                textField: 'text'
                            },
                            render: function (item) {
                                return item.confirmenum;
                            }
                        },
                        {display: '表具止码', name: 'fmeterreading', width: '9%', editor: {type: 'text'}},
                        {display: '分析时间', name: 'fdatetime', width: '9%', editor: {type: 'date'}},
                        {
                            display: '操作', isSort: false, width: '10%', render: function (rowdata, rowindex, value) {
                            var h = "";
                            if (!rowdata._editing) {
                                h += "<a href='javascript:beginEdit(" + rowindex + ")'>修改</a> ";
                                h += "<a href='javascript:deleteRow(" + rowindex + ")'>删除</a> ";
                            }
                            else {
                                h += "<a href='javascript:endEdit(" + rowindex + ")'>提交</a> ";
                                h += "<a href='javascript:cancelEdit(" + rowindex + ")'>取消</a> ";
                            }
                            return h;
                        }
                        }
                    ],
                    onSelectRow: function (rowdata, rowindex) {
                        $("#txtrowindex").val(rowindex);
                    },
                    enabledEdit: true, clickToEdit: false, isScroll: false,
                    data: gridData,
                    width: '100%'
                });
            }

        function beginEdit(rowid) {
                manager.beginEdit(rowid);
            }

        function cancelEdit(rowid) {
            manager.cancelEdit(rowid);
        }

        function endEdit(rowid) {
                manager.endEdit(rowid);
                var row = manager.getRow(rowid);
                var jsonString = $.toJSON(row);
                $.post($.URL.meterAnalysis.update,{"jsonString": jsonString},updateCallback,"json");
                document.getElementById('form2').reset();
                c_show1();
                $.ligerDialog.open({ target: $("#addUpdateMeterAnalysis"),width:500,title:'添加数据修改记录'});
                function updateCallback(data) {
                    if (data.code == 200) {
                        $.ligerDialog.success("修改成功");
                        window.afterData = manager.getRow(rowid);
                        $.post($.URL.meterAnalysis.list, null,listCallback, "json");
                    }
                    else {
                        $.post($.URL.meterAnalysis.list, null,listCallback, "json");
                        $.ligerDialog.warn(data.message);
                    }
                }
            }

        function deleteRow(rowid) {
                if (confirm('确定删除?')) {
                    var row = manager.getRow(rowid);
                    var jsonString = $.toJSON(row);
                    $.post($.URL.meterAnalysis.delete, {"jsonString": jsonString},deleteCallback, "json");
                    manager.deleteRow(rowid);
                }
            }

        function deleteCallback(data) {
                if (data.code == 200) {
                    $.ligerDialog.success("成功删除！");
                    $.post($.URL.meterAnalysis.list,null,listCallback, "json");
                } else {
                    $.ligerDialog.success("删除失败！");
                }
            }

        $("#addSubmitBtn").click(function () {
            {
                document.getElementById('form1').reset();
                c_show();
                $.ligerDialog.open({target: $("#addMeterAnalysis"), width: 500, title: '添加维修分析表'});
            }
        });
        function c_show() {
            $('#addMeterAnalysis').css('display', 'block');
        }
//        function c_show1(){
//            $('#addUpdateMeterAnalysis').css('display','block');
//        }

        $("#submitBtn").click(function () {
            var gdata={};
            gdata.fanalysor = getCookie("userName");
            gdata.fdepartment = getCookie("departName");
            gdata.fmetercode = $("#fmetercode").val();
            gdata.fcustomer = $("#fcustomer").val();
            gdata.freportmisfune = $("#freportmisfune").val();
            gdata.fconfirmmisfune = $("#fconfirmmisfune").val();
            gdata.fmisfunedescrib = $("#fmisfuneinfo").val();
            gdata.fmeterreading = $("#fmeterreading").val();
            gdata.felecdisplay = $("#felecdisplay").val();
            $.post($.URL.returnValveAndName.findValveAndName,{"fmetercode":gdata.fmetercode},getValveListCallback,"json");
            function getValveListCallback(data) {
                if(data.data==null)
                {
                    $.ligerDialog.alert("参数为空");
                }
                else
                {
                    gdata.fmetername = data.data[0].fmetername;
                    gdata.fvalvename = data.data[0].fvalvename;
                    $.post($.URL.meterAnalysis.add,{"jsonString":$.toJSON(gdata)},addCallback,"json");
                }
            }
        });
//        $("#updateSubmitBtn").click(function () {
//            var data={};
//            switch ($("#dataname").val())
//            {
//                case "表具编号":data.updateafter = afterData.fmetercode;break;
//                case "部门":data.updateafter = afterData.fdepartment;break;
//                case "分析人员":data.updateafter = afterData.fanalysor;break;
//                case "天然气公司":data.updateafter = afterData.fcustomer;break;
//                case "报修故障":data.updateafter = afterData.freportmisfune;break;
//                case "实查故障":data.updateafter = afterData.fconfirmmisfune;break;
//                case "表具止码":data.updateafter = afterData.fmeterreading;break;
//                case "分析时间":data.updateafter = afterData.fdatetime;break;
//            }
//            data.dataname = $("#dataname").val();
//            data.updatedate = $("#updatedate").val();
//            data.updateoperator = $("#updateoperator").val();
//            data.updatename = "维修分析表";
//            data.updatekey = afterData.id;
//            data.updatebefore = $("#updatebefore").val();
//            $.post($.URL.updateRecord.add,{"jsonString":$.toJSON(data)},RecordCallback,"json");
//            function RecordCallback(data){
//                if(data.code==200){
//                    $.ligerDialog.success(data.message);
//                    document.getElementById('form2').reset();
//                    $.post($.URL.meterAnalysis.list, null,listCallback,"json");
//                }
//                else{
//                    $.ligerDialog.warn(data.message);
//                }
//            }
//        });

        function addCallback(data){
            if (data.code == 200) {
                $.ligerDialog.success(data.message);
                document.getElementById('form1').reset();
                $.post($.URL.meterAnalysis.list,null,listCallback,"json");
                $.ligerDialog.hide("#addMeterAnalysis");
            }
            else {
                $.ligerDialog.warn(data.message);
            }
        }

        $("#analysisSearchBtn").click(function () {
            var fmetercode = $("#code").val();
            var fmetername = $("#type").val();
            $.post($.URL.meterAnalysis.findBySearch,{"fmetercode":fmetercode,"fmetername":fmetername},listCallback,"json");
        });
    </script>
    <style type="text/css">
        .l-table-edit {}
        .l-table-edit-td{margin-left:30px; margin-top:10px;padding:4px;height: 20px}
        .l-table-edit-input{ padding:4px;width:300px}
        .l-button-submit,.l-button-reset{width:80px; float:left; margin-left:10px; padding-bottom:2px;}
        .l-dialog-tc{background:#E0EDFF; }
    </style>
</head>
<body style="padding:10px">
<div id="list">
    <table cellpadding="0" cellspacing="0" class="l-table-edit" >
        <tr>
            <td align="right" class="l-table-edit-td">表具编号:</td>
            <td align="left" class="l-table-edit-td">
                <input name="code" type="text" id="code"/>
            </td>
            <td align="right" class="l-table-edit-td">表具类型:</td>
            <td align="left" class="l-table-edit-td">
                <input name="type" type="text"  id="type">
            </td>
            <td align="right"><input type="button" value="查询" id="analysisSearchBtn" class="l-button l-button-submit" /></td>
            <td align="right"><input type="button" value="添加" id="addSubmitBtn" class="l-button l-button-submit" /></td>
        </tr>
    </table>
    <div class="l-clear"></div>
</div>
<div id="addMeterAnalysis" style=" margin:3px; display:none;">
    <form name="form1" method="post" action="" id="form1" style="margin-left: 15px">
        <table cellpadding="0" cellspacing="0" class="l-table-edit" >
            <tr>
                <td align="right" class="l-table-edit-td">表具编号:</td>
                <td align="left" class="l-table-edit-td"><input name="fmetercode" type="text" id="fmetercode"></td>
                <td align="left"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">市场:</td>
                <td align="left" class="l-table-edit-td">
                    <select name="fcustomer" id="fcustomer" >
                        <!--js控制添加市场-->
                    </select></td>
                <td align="left"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">报修故障:</td>
                <td align="left" class="l-table-edit-td">
                    <select name="freportmisfune" id="freportmisfune" >
                        <!--js控制添加报修故障-->
                    </select></td>
                <td align="left"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">实查故障:</td>
                <td align="left" class="l-table-edit-td">
                    <select name="fconfirmmisfune" id="fconfirmmisfune" >
                        <!--js控制添加实查故障-->
                    </select></td>
                <td align="left"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">故障详情:</td>
                <td align="left" class="l-table-edit-td">
                    <select name="fmisfuneinfo" id="fmisfuneinfo" >
                        <!--js控制添加故障详情-->
                    </select></td>
                <td align="left"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">表具止码:</td>
                <td align="left" class="l-table-edit-td"><input name="fmeterreading" type="text" id="fmeterreading" ></td>
                <td align="left"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">上电显示状态:</td>
                <td align="left" class="l-table-edit-td">
                    <select name="felecdisplay" type="text" id="felecdisplay" >
                        <!--js控制添加上电显示状态-->
                    </select></td>
                <td align="left"></td>
            </tr>
        </table>
        <br/>
        <input type="button" value="提交" id="submitBtn" class="l-button l-button-submit" />
    </form>
</div>
<div style="display:none;">
</div>
<div id="maingrid" style="margin-top:5px"></div>
<!--<div id="addUpdateMeterAnalysis" style=" margin:3px; display:none;">-->
    <!--<form name="form2" method="post" action="" id="form2" style="margin-left: 15px">-->
        <!--<table cellpadding="0" cellspacing="0" class="l-table-edit" >-->
            <!--<tr>-->
                <!--<td align="right" class="l-table-edit-td">修改数据名:</td>-->
                <!--<td align="left" class="l-table-edit-td">-->
                    <!--<select id="dataname">-->
                        <!--<option value="表具编号">表具编号</option>-->
                        <!--<option value="部门">部门</option>-->
                        <!--<option value="分析人员">分析人员</option>-->
                        <!--<option value="报修故障">报修故障</option>-->
                        <!--<option value="实查故障">实查故障</option>-->
                        <!--<option value="表具止码">表具止码</option>-->
                        <!--<option value="分析时间">分析时间</option>-->
                    <!--</select>-->
                <!--</td>-->
                <!--<td align="left"></td>-->
            <!--</tr>-->

            <!--<tr>-->
                <!--<td align="right" class="l-table-edit-td">修改日期:</td>-->
                <!--<td align="left" class="l-table-edit-td"><input name="updatedate" type="date" id="updatedate" ></td>-->
                <!--<td align="left"></td>-->
            <!--</tr>-->

            <!--<tr>-->
                <!--<td align="right" class="l-table-edit-td">修改人员:</td>-->
                <!--<td align="left" class="l-table-edit-td"><input name="updateoperator" type="text" id="updateoperator" ></td>-->
                <!--<td align="left"></td>-->
            <!--</tr>-->

            <!--<tr>-->
                <!--<td align="right" class="l-table-edit-td">修改前数据:</td>-->
                <!--<td align="left" class="l-table-edit-td"><input name="updatebefore" type="text" id="updatebefore" ></td>-->
                <!--<td align="left"></td>-->
            <!--</tr>-->
        <!--</table>-->
        <!--<br />-->
        <!--<input type="button" value="提交" id="updateSubmitBtn" class="l-button l-button-submit" />-->
    <!--</form>-->
<!--</div>-->
</body>
</html>