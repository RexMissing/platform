<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="lib/assert/select/combo.select.css" type="text/css"/>
    <script src="lib/json2.js" type="text/javascript"></script>
    <script src="lib/assert/select/jquery.combo.select.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerDialog.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerTextBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerCheckBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerComboBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerGrid.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerDateEditor.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerSpinner.js" type="text/javascript"></script>
    <script src="js/highcharts.js" type="text/javascript"></script>
    <script src="js/exporting.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            $.post($.URL.enumTable.meterlist,null,enumMeterListCallBack,"json");
            var date = new Date();
            var year = date.getFullYear();
            $("#saleyear1").empty();
            $("#saleyear2").empty();
            $("#compareYear1").empty();
            $("#compareYear2").empty();
            $("#year1").empty();
            $("#year2").empty();
            $("#year").empty();
            for(var i = 0; i < 20; i++){
                $("#compareYear1").append("<option value='" + (year - i) + "'>" + (year - i) + "</option>");
                $("#compareYear2").append("<option value='" + (year - i) + "'>" + (year - i) + "</option>");
                $("#year1").append("<option value='" + (year - i) + "'>" + (year - i) + "</option>");
                $("#year2").append("<option value='" + (year - i) + "'>" + (year - i) + "</option>");
                $("#saleyear1").append("<option value='" + (year - i) + "'>" + (year - i) + "</option>");
                $("#saleyear2").append("<option value='" + (year - i) + "'>" + (year - i) + "</option>");
                $("#year").append("<option value='" + (year - i) + "'>" + (year - i) + "</option>");
            }
        });
        function enumMeterListCallBack(data) {
            if (data.code == 200) {
                $("#fmeternames").empty();
                for(var i = 0; i < data.data.length; i++){
                    $("#fmeternames").append("<option value='" + data.data[i].fenumname + "'>" + data.data[i].fenumname + "</option>");
                }
                $("#fmeternames").comboSelect();
            }
        }
        function rebutton() {
            $.ligerDialog.warn("请求无数据，请更换查询条件...");
            $("#submitBtn1").attr("disabled",false);
        }
        var years = new Array();
        var yearMis = new Array();
        var compareYears = new Array();
        var saleYears = new Array();
        $("#submitBtn1").click(function () {
            $("#loading").css("display","block");
            $("#loadingerror").css("display","none");
            $("#submitBtn1").attr("disabled",true);
            var graphType = $("#graphType").val();
            if (graphType == 0){
                var compareYear1 = $("#compareYear1").val();
                var compareYear2 = $("#compareYear2").val();
                var maxYear = (parseInt(compareYear1) > parseInt(compareYear2)) ? parseInt(compareYear1):parseInt(compareYear2);
                var fmeternames = $("#fmeternames").val();
                $.ajax(
                    {
                        type:"post",
                        url:$.URL.graph.xYear,
                        data:{"compareYear1":compareYear1,"compareYear2":compareYear2,"fmeternames":fmeternames},
                        async:false,
                        success:function(data){
                            if(data.data.length==0)
                            {
                                rebutton();
                                $("#loading").css("display","none");
                                $("#loadingerror").css("display","block");
                                return false;
                            }
                            else{
                                var minYear = data.data[0].minYear;
                                if (parseInt(minYear) > parseInt(maxYear))
                                {
                                    rebutton();
                                    $("#loading").css("display","none");
                                    $("#loadingerror").css("display","block");
                                    return false;
                                }
                                for (var i = 0; i <= parseInt(maxYear) - parseInt(minYear); i++){
                                    years[i] = (parseInt(minYear) + i).toString();
                                }
                                $.post($.URL.graph.graphYears, {"compareYear1":compareYear1,"compareYear2":compareYear2,
                                                                "fmeternames":fmeternames,"minYear":minYear,"maxYear":maxYear},
                                        showYears, "json");
                            }
                        },
                        dataType:"json"
                    }
                );
            }
            else if (graphType == 1){
                var year = $("#year").val();
                var fmeternames = $("#fmeternames").val();
                $.ajax(
                    {
                        type:"post",
                        url:$.URL.graph.year,
                        data:{"year":year,"fmeternames":fmeternames},
                        async:false,
                        success:function(data){
                            if(data.data.length==0)
                            {
                                rebutton();
                                $("#loading").css("display","none");
                                $("#loadingerror").css("display","block");
                                return false;
                            }
                            else{
                                var minYear = data.data[0].minYear;
                                if (parseInt(minYear) > parseInt(year))
                                {
                                    rebutton();
                                    $("#loading").css("display","none");
                                    $("#loadingerror").css("display","block");
                                    return false;
                                }
                                for (var i = 0; i <= parseInt(year) - parseInt(minYear); i++){
                                    yearMis[i] = (parseInt(minYear) + i).toString();
                                }
                                $.post($.URL.graph.graphYear, {"year":year,"fmeternames":fmeternames,"minYear":minYear},
                                        showYear, "json");
                            }
                        },
                        dataType:"json"
                    }
                );
            }
            else if (graphType == 2){
                var year1 = $("#year1").val();
                var year2 = $("#year2").val();
                var maxYear = (parseInt(year1) > parseInt(year2)) ? parseInt(year1):parseInt(year2);
                var fmeternames = $("#fmeternames").val();
                $.ajax(
                    {
                        type:"post",
                        url:$.URL.graph.xYear,
                        data:{"compareYear1":year1,"compareYear2":year2,"fmeternames":fmeternames},
                        async:false,
                        success:function(data){
                            if(data.data.length==0)
                            {
                                rebutton();
                                $("#loading").css("display","none");
                                $("#loadingerror").css("display","block");
                                return false;
                            }
                            else{
                                var minYear = data.data[0].minYear;
                                if (parseInt(minYear) > parseInt(maxYear))
                                {
                                    rebutton();
                                    $("#loading").css("display","none");
                                    $("#loadingerror").css("display","block");
                                    return false;
                                }
                                for (var i = 0; i <= parseInt(maxYear) - parseInt(minYear); i++){
                                    compareYears[i] = (parseInt(minYear) + i).toString();
                                }
                                $.post($.URL.graph.graphCompareYears, {"compareYear1":year1,"compareYear2":year2,
                                            "fmeternames":fmeternames,"minYear":minYear,"maxYear":maxYear},
                                        showCompareYears, "json");
                            }
                        },
                        dataType:"json"
                    }
                );
            }
            else if (graphType == 3){
                var saleyear1 = $("#saleyear1").val();
                var saleyear2 = $("#saleyear2").val();
                var fmeternames = $("#fmeternames").val();
                var maxYear = (parseInt(saleyear1) > parseInt(saleyear2)) ? parseInt(saleyear1):parseInt(saleyear2);
                var minYear = (parseInt(saleyear1) < parseInt(saleyear2)) ? parseInt(saleyear1):parseInt(saleyear2);
                for (var i = 0; i <= parseInt(maxYear) - parseInt(minYear); i++){
                    saleYears[i] = (parseInt(minYear) + i).toString();
                }
                $.post($.URL.graph.graphSaleYears, {"fmeternames":fmeternames,"minYear":minYear,"maxYear":maxYear},
                        showSaleYears, "json");
            }

        });
        function showSaleYears(data) {
            if (data.code == 200){
                if(data.data.length==0)
                {
                    rebutton();
                    $("#loading").css("display","none");
                    $("#loadingerror").css("display","block");
                    return false;
                }
                var number = new Array();
                for(var i = 0; i < data.data.length; i++){
                    number[i] = data.data[i].number1;
                }
                $("#containerMonth").css("display", "none");
                $("#containerYear").css("display", "none");
                $("#containerYearNumber").css("display", "none");
                $("#containerSaleYear").css("display", "block");
                $('#containerSaleYear').highcharts({
                    chart: {
                        type: 'column'
                    },
                    credits: {
                        text: '武汉理工大学',
                        href: false
                    },
                    title: {
                        text: $("#fmeternames").val() + '表年销售数量对比图'
                    },
                    xAxis: {
                        categories: saleYears,
                        crosshair: true
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: '返修表数量 (块)'
                        }
                    },
                    tooltip: {
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y} 块</b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            pointPadding: 0.2,
                            borderWidth: 0
                        }
                    },
                    series: [{
                        name: $("#fmeternames").val() + '表年销售数量',
                        data: number
                    }]
                });
                $("#loading").css("display","none");
                $("#submitBtn1").attr("disabled",false);
            }
        }
        function showCompareYears(data) {
            if (data.code == 200){
                var number1 = new Array();
                var number2 = new Array();
                for(var i = 0; i < data.data.length; i++){
                    number1[i] = data.data[i].number1;
                    number2[i] = data.data[i].number2;
                }
                $("#containerMonth").css("display", "none");
                $("#containerYear").css("display", "none");
                $("#containerYearNumber").css("display", "block");
                $("#containerSaleYear").css("display", "none");
                $('#containerYearNumber').highcharts({
                    chart: {
                        type: 'column'
                    },
                    credits: {
                        text: '武汉理工大学',
                        href: false
                    },
                    title: {
                        text:$("#fmeternames").val() + '返修表年故障数量对比图'
                    },
                    xAxis: {
                        categories: compareYears,
                        crosshair: true
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: '返修表数量 (块)'
                        }
                    },
                    tooltip: {
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y} 块</b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            pointPadding: 0.2,
                            borderWidth: 0
                        }
                    },
                    series: [{
                        name: $("#year1").val(),
                        data: number1
                    }, {
                        name: $("#year2").val(),
                        data: number2
                    }]
                });
                $("#loading").css("display","none");
                $("#submitBtn1").attr("disabled",false);
            }
        }
        function showYears(data) {
            var yearsReturnRate1 = new Array();
            var yearsReturnRate2 = new Array();
            if (data.code == 200) {
                for (var i = 0; i < years.length; i++) {
                    yearsReturnRate1[i] = parseFloat((data.data[i].rate1 * 100).toFixed(5));
                    yearsReturnRate2[i] = parseFloat((data.data[i].rate2 * 100).toFixed(5));
                }
                $("#containerMonth").css("display", "none");
                $("#containerYearNumber").css("display", "none");
                $("#containerYear").css("display", "block");
                $("#containerSaleYear").css("display", "none");
                var chart = new Highcharts.Chart('containerYear', {
                    title: {
                        text:$("#fmeternames").val() + '返修表各年故障率趋势图',
                        x: -20
                    },
                    credits: {
                        text: '武汉理工大学',
                        href: false
                    },
                    subtitle: {
                        x: -20
                    },
                    xAxis: {
                        categories: years
                    },
                    yAxis: {
                        title: {
                            text: '年故障率 (%)'
                        },
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }]
                    },
                    tooltip: {
                        valueSuffix: '%'
                    },
                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle',
                        borderWidth: 0
                    },
                    series: [{
                        name: $("#compareYear1").val(),
                        data: yearsReturnRate1
                    },{
                        name: $("#compareYear2").val(),
                        data: yearsReturnRate2
                    }]
                });
                $("#loading").css("display","none");
                $("#submitBtn1").attr("disabled",false);
            }
            else
                $.ligerDialog.error("查询错误");
        }
        function showYear(data) {
            var yearReturnRate = new Array();
            if(data.code == 200){
                for (var i = 0; i < data.data.length; i++){
                    yearReturnRate[i] = parseFloat((data.data[i].rate * 100).toFixed(5));
                }
                $("#containerYear").css("display","none");
                $("#containerYearNumber").css("display", "none");
                $("#containerMonth").css("display","block");
                $("#containerSaleYear").css("display", "none");
                var chart = new Highcharts.Chart('containerMonth', {
                    title: {
                        text:$("#fmeternames").val() + '返修表年故障率趋势图',
                        x: -20
                    },
                    credits:{
                        text: '武汉理工大学',
                        href: false
                    },
                    subtitle: {
                        x: -20
                    },
                    xAxis: {
                        categories: yearMis
                    },
                    yAxis: {
                        title: {
                            text: '故障率 (%)'
                        },
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }]
                    },
                    tooltip: {
                        valueSuffix: '%'
                    },
                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle',
                        borderWidth: 0
                    },
                    series: [{
                        name: '返修表故障率',
                        data: yearReturnRate
                    }]
                });
                $("#loading").css("display","none");
                $("#submitBtn1").attr("disabled",false);
            }
            else
                $.ligerDialog.error("查询错误");
        }
        function graphTypeChange(){
            if($("#graphType").val() == 3){
                $("#compareYears").css("display","none");
                $("#compareQuery").css("display","none");
                $("#years").css("display","none");
                $("#saleyears").css("display","block");
            }
            else if($("#graphType").val() == 2){
                $("#compareYears").css("display","none");
                $("#compareQuery").css("display","block");
                $("#years").css("display","none");
                $("#saleyears").css("display","none");
            }
            else if($("#graphType").val() == 1){
                $("#compareYears").css("display","none");
                $("#compareQuery").css("display","none");
                $("#years").css("display","block");
                $("#saleyears").css("display","none");
            }
            else {
                $("#compareYears").css("display","block");
                $("#years").css("display","none");
                $("#compareQuery").css("display","none");
                $("#saleyears").css("display","none");
            }
        }
    </script>
    <style type="text/css">
        .l-table-edit {}
        .l-table-edit-td{ padding:4px;}
        .l-button-submit,.l-button-reset{width:80px; float:left; margin-left:10px; padding-bottom:2px;}
        .l-dialog-tc{background:#E0EDFF;}

    </style>
</head>
<body style="padding:10px">
<div class="l-clear"></div>
<div>
    <div cellpadding="0" cellspacing="0" class="l-table-edit" >
        <table>
            <tr>
                <td class="l-table-edit-td">
                    <select id="graphType" onchange="graphTypeChange()">
                        <option value="0">返修表各年故障率趋势图</option>
                        <option value="1">返修表年故障率趋势图</option>
                        <option value="2">返修表年故障数量对比图</option>
                        <option value="3">表具年销售数量对比图</option>
                    </select>
                </td>
                <td class="l-table-edit-td">表具类型选择</td>
                <td class="l-table-edit-td">
                    <select id="fmeternames" >
                    </select>
                </td>
            </tr>
        </table>
        <div id="compareYears" style="display:block;">
            <table>
                <tr>
                    <td class="l-table-edit-td">年份选择</td>
                    <td class="l-table-edit-td">
                        <select id="compareYear1">
                        </select>
                    </td>
                    <td class="l-table-edit-td">对比</td>
                    <td class="l-table-edit-td">
                        <select id="compareYear2">
                        </select>
                    </td>
                </tr>
            </table>
        </div>
        <div id="years" style="display: none">
            <table>
                <tr>
                    <td class="l-table-edit-td">年份选择</td>
                    <td>
                        <select id="year">
                        </select>
                    </td>
                </tr>
            </table>
        </div>
        <div id="compareQuery" style="display:none;">
            <table>
                <tr>
                    <td class="l-table-edit-td">年份选择</td>
                    <td class="l-table-edit-td">
                        <select id="year1">
                        </select>
                    </td>
                    <td class="l-table-edit-td">对比</td>
                    <td class="l-table-edit-td">
                        <select id="year2">
                        </select>
                    </td>
                </tr>
            </table>
        </div>
        <div id="saleyears" style="display: none">
            <table>
                <tr>
                    <td class="l-table-edit-td">年份选择</td>
                    <td class="l-table-edit-td">
                        <select id="saleyear1">
                        </select>
                    </td>
                    <td class="l-table-edit-td">至</td>
                    <td class="l-table-edit-td">
                        <select id="saleyear2">
                        </select>
                    </td>
                </tr>
            </table>
        </div>
        <div>
            <table>
                <tr>
                    <td align="right"><input type="button" value="查询" id="submitBtn1" class="l-button l-button-submit" /></td>
                </tr>
            </table>
        </div>
    </div>
</div>
<div id="loading" style="display:none;font-size: 18px;">正在加载中，请稍后...</div>
<div id="loadingerror" style="display:none;font-size: 18px;">请求无数据，请更换查询条件...</div>
<div id="containerMonth" style="min-width: 400px;height: 400px;display: none"></div>
<div id="containerYear" style="min-width: 400px;height: 400px;display: block"></div>
<div id="containerYearNumber" style="min-width: 400px;height: 400px;display: none"></div>
<div id="containerSaleYear" style="min-width: 400px;height: 400px;display: none"></div>
</body>
</html>